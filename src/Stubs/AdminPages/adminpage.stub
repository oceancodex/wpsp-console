<?php

namespace {{ rootNamespace }}\app\Extras\Components\AdminPages;

use Symfony\Contracts\Cache\ItemInterface;
use {{ rootNamespace }}\app\Extras\Components\License\License;
use {{ rootNamespace }}\app\Extras\Instances\Cache\Cache;
use {{ rootNamespace }}\app\Extras\Instances\Cache\RateLimiter;
use {{ rootNamespace }}\app\Extras\Instances\Database\Migration;
use {{ rootNamespace }}\app\Models\SettingsModel;
use {{ rootNamespace }}\app\Models\UsersModel;
use {{ rootNamespace }}\app\Models\VideosModel;
use {{ rootNamespace }}\app\Traits\InstancesTrait;
use {{ rootNamespace }}\app\View\Share;
use {{ rootNamespace }}\Funcs;
use {{ coreNamespace }}\Base\BaseAdminPage;

class {{ className }} extends BaseAdminPage {

	use InstancesTrait;

	/**
	 * WordPress admin page properties.
	 */
	public $menu_title                  = '{{ name }}';
//	public $page_title                  = '{{ name }}';
	public $capability                  = 'manage_options';
//	public $menu_slug                   = '{{ path_slugify }}';
	public $icon_url                    = 'dashicons-admin-generic';
//	public $position                    = 2;
//	public $parent_slug                 = 'options-general.php';
//	public $is_submenu_page             = false;
//	public $remove_first_submenu        = false;
//	public $urls_highlight_current_menu = null;
//	public $callback_function           = null;

	/**
	 * Parent properties.
	 */
	protected $screen_options           = null;
	protected $screen_options_key       = null;

	/**
	 * Custom properties.
	 */
//	private $checkDatabase              = null;
	private $table                      = null;
	private $currentTab                 = null;
	private $currentPage                = null;

	/*
	 *
	 */

	public function customProperties() {
//		$this->menu_title                  = '';
//		$this->page_title                  = '';
//		$this->capability                  = '';
//		$this->menu_slug                   = '';
//		$this->icon_url                    = '';
//		$this->position                    = '';
//		$this->parent_slug                 = '';
//		$this->is_submenu_page             = true;
//	    $this->remove_first_submenu        = false;
//		$this->urls_highlight_current_menu = [];
//      $this->callback_function           = null;
//      $this->$screen_options             = null;
//      $this->$screen_options_key         = null;

		$this->currentTab  = $this->request->get('tab');
		$this->currentPage = $this->request->get('page');
		if (class_exists('\{{ coreNamespace }}\Translation\Translator')) {
			$this->page_title = ($this->currentTab ? Funcs::trans('messages.' . $this->currentTab) : Funcs::trans('messages.{{ name }}')) . ' - ' . Funcs::config('app.name');
		}
		else {
			$pageTitle = $this->currentTab ?? 'Dashboard';
			$this->page_title = Funcs::trans(ucfirst($pageTitle), true);
		}
//		$this->screen_options_key = $this->getQueryStringSlugify(['page', 'tab']);
//		if (in_array($this->currentTab, ['table', 'roles', 'permissions', 'users'])) {
//			$this->screen_options = true;
//		}
	}

	/*
	 *
	 */

//	public function init($path = null) {
//		// You must call to parent method "init" if you want to custom it.
//		parent::init();
//
//      // Your code here...
//	}

	public function beforeInit() {
		if (!Auth::instance()->guard('web')->check() && $this->currentTab == 'users') {
			// Test AuthenticationException.
//			throw new AuthenticationException('Vui lòng đăng nhập để xem users', ['web'], admin_url('admin.php?page=wpsp'));

			// Test QueryException.
//			global $wpdb;
//			$data = ['title' => 'Test'];
//			$result = $wpdb->update($wpdb->posts, $data, ['ID' => 1]);
//			throw new \WPSP\app\Exceptions\QueryException($wpdb->last_query, $data, 'Failed to update post');
		}
	}

	public function afterInit() {
		// Custom highlight current menu.
//		if (preg_match('/' . $this->menu_slug . '$|' . $this->menu_slug . '&updated=true$/', $this->request->getRequestUri())) {
//			add_filter('submenu_file', function($submenu_file) {
//				return $this->menu_slug;
//			});
//		}

		// Redirect to the "Database" tab if database version not valid.
//		try {
//			if ($this->currentPage == $this->menu_slug) {
//				// Check database version and maybe redirect.
//				$this->checkDatabase = Migration::instance()->checkDatabaseVersion();
//				if (empty($this->checkDatabase['result']) && $this->currentPage == $this->getMenuSlug() && $this->currentTab !== 'database') {
//					$url = Funcs::instance()->_buildUrl($this->getParentSlug(), [
//						'page' => $this->getMenuSlug(),
//						'tab'  => 'database',
//					]);
//					wp_redirect($url);
//				}
//			}
//		}
//		catch (\Throwable $e) {
//			Funcs::debug($e->getMessage());
//		}
	}

	public function afterLoad($adminPage) {
//		if (in_array($this->request->get('tab'), ['table'])) {
//			$this->table = new \{{ rootNamespace }}\app\Extras\Components\ListTables\Settings();
//		}
	}

//	public function screenOptions($adminPage) {
//		if ($this->request->get('tab') == 'table') {
//			parent::screenOptions($adminPage);
//		}
//	}

	/*
	 *
	 */

	public function index() {
		$updated = $this->request->get('updated') ?? null;

		if ($updated && $this->parent_slug !== 'options-general.php' && $this->request->get('tab') !== 'table') {
			if ($updated == 'custom-updated') {
				Funcs::notice(
					Funcs::trans('Custom updated successfully', true),
					'success',
					!class_exists('\{{ coreNamespace }}\View\Blade')
				);
			}
			else {
				Funcs::notice(
					Funcs::trans('Updated successfully', true),
					'success',
					!class_exists('\{{ coreNamespace }}\View\Blade')
				);
			}
		}

//		$requestParams = $this->request->query->all();
//		$menuSlug      = $this->getMenuSlug();

		try {
//		    $checkLicense  = License::checkLicense();

			// Test cache.
//			$cacheTest = Cache::get('cache-test', function(ItemInterface $item) {
//				$item->expiresAfter(60);
//				return 'This is a cached value';
//			});
//			echo '<pre style="z-index: 9999; position: relative; clear: both;">'; print_r($cacheTest); echo '</pre>';

			$table = $this->table;

			echo '<div class="wrap"><h1>Admin page: "{{ name }}"</h1></div>';
		}
		catch (\Throwable $e) {
			Funcs::notice($e->getMessage() . ' <code>(' . __CLASS__ . ')</code>', 'error', true, true);
		}
	}

	public function update() {
		// Validate sử dụng FormRequest.
//		$request = new SettingsUpdateRequest();
//		$request->validated();

//		wp_safe_redirect(wp_get_raw_referer() . '&updated=true');
	}

	/*
	 *
	 */

	public function styles() {
		wp_enqueue_style(
			Funcs::config('app.short_name') . '-bootstrap-grid',
			Funcs::instance()->_getPublicUrl() . '/plugins/bootstrap/css/bootstrap-grid.min.css',
			null,
			Funcs::instance()->_getVersion()
		);
		wp_enqueue_style(
			Funcs::config('app.short_name') . '-bootstrap-utilities',
			Funcs::instance()->_getPublicUrl() . '/plugins/bootstrap/css/bootstrap-utilities.min.css',
			null,
			Funcs::instance()->_getVersion()
		);
	}

	public function scripts() {
//		wp_enqueue_script();
	}

	public function localizeScripts() {
//		wp_localize_script();
	}

}